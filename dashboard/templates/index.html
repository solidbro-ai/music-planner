{% extends "base.html" %}

{% block title %}Dashboard - Music Planner{% endblock %}

{% block content %}
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flash-messages">
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="page-header">
    <h1 class="page-title">Dashboard</h1>
    <p class="page-subtitle">Welcome back, {{ current_user.username }}! ðŸŽµ</p>
</div>

<div class="stats-grid" id="stats">
    <div class="stat-card">
        <div class="stat-value" id="stat-songs">-</div>
        <div class="stat-label">Songs Generated</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="stat-artists">-</div>
        <div class="stat-label">AI Artists</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="stat-genres">-</div>
        <div class="stat-label">Genre Guides</div>
    </div>
</div>

<div id="import-banner" class="card" style="margin-bottom: 24px; display: none; background: var(--bg-tertiary);">
    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
        <div>
            <h3 style="margin-bottom: 8px; font-weight: 600;">ðŸ“¦ Import Existing Data</h3>
            <p style="color: var(--text-secondary); margin: 0;">Found existing songs and artists. Import them to your account?</p>
        </div>
        <form action="/migrate" method="POST" style="margin: 0;">
            <button type="submit" class="btn btn-primary btn-sm">Import Data</button>
        </form>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
    <div class="card">
        <h3 style="margin-bottom: 16px; font-weight: 600;">Quick Generate</h3>
        <p style="color: var(--text-secondary); margin-bottom: 20px;">Create a song in seconds</p>
        <a href="/generate" class="btn btn-primary">
            <span>âœ¨</span> Generate Song
        </a>
    </div>
    
    <div class="card">
        <h3 style="margin-bottom: 16px; font-weight: 600;">Recent Songs</h3>
        <div id="recent-songs" style="color: var(--text-secondary);">Loading...</div>
    </div>
</div>

<div style="margin-top: 24px;">
    <h3 style="margin-bottom: 16px; font-weight: 600;">Featured Artists</h3>
    <div class="card-grid" id="featured-artists">
        <div class="loading"><div class="spinner"></div></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
async function loadDashboard() {
    // Load stats
    const stats = await fetch('/api/stats').then(r => r.json());
    document.getElementById('stat-songs').textContent = stats.songs;
    document.getElementById('stat-artists').textContent = stats.artists;
    document.getElementById('stat-genres').textContent = stats.genres;
    
    // Show import banner if user has no songs but there's legacy data
    if (stats.songs === 0 && stats.hasLegacyData) {
        document.getElementById('import-banner').style.display = 'block';
    }
    
    // Load recent songs
    const songs = await fetch('/api/songs').then(r => r.json());
    const recentContainer = document.getElementById('recent-songs');
    if (songs.length === 0) {
        recentContainer.innerHTML = '<p>No songs yet. <a href="/generate" style="color: var(--accent);">Generate one!</a></p>';
    } else {
        recentContainer.innerHTML = songs.slice(0, 3).map(song => `
            <div style="padding: 12px 0; border-bottom: 1px solid var(--border);">
                <div style="font-weight: 500; color: var(--text-primary);">${song.artist}</div>
                <div style="font-size: 13px; color: var(--text-muted);">${song.concept.substring(0, 50)}...</div>
            </div>
        `).join('');
    }
    
    // Load featured artists
    const artists = await fetch('/api/artists').then(r => r.json());
    const artistsContainer = document.getElementById('featured-artists');
    artistsContainer.innerHTML = artists.slice(0, 4).map(artist => `
        <div class="artist-card">
            <div class="artist-name">${artist.name || artist.filename}</div>
            <div class="artist-personality">${artist.personality || 'AI Artist'}</div>
            <div class="artist-meta">
                <span class="artist-tag energy-${artist.energy || 'medium'}">${artist.energy || 'medium'} energy</span>
                <span class="artist-tag">${artist.vocal_gender || 'any'}</span>
            </div>
        </div>
    `).join('');
}

loadDashboard();
</script>
{% endblock %}
